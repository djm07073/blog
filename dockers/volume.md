### 도커 볼륨을 이용한 퍼시스턴트 스토리지
- 상태 관리가 필요가 없는 어플리케이션에서 도커를 사용해서 실행하는것은 최적의 환경입니다. 하지만 상태관리 즉, 디스크에 파일을 저장하는 등의 행위는 
자주 발생하므로 이를 관리하는 기술이 필요합니다. 그때 필요한 개념니 도커 볼륨과 마운트입니다.

### 컨테이너 속 데이터가 사라지는 이유
- 같은 이미지로 만든 컨테이너라 할지라도 각각의 컨테이너에서 생기는 파일을 같지 않습니다.
- 컨테이너를 종료해도 파일 시스템은 삭제되지 않는데요. 그러므로 컨테이너의 파일과 디렉터리는 그대로 남아있습니다.
- 그 이유는 이미지중 기록 가능 레이어가 추가되어 컨테이너가 운영이 되기 때문입니다.
#### 기록 가능 레이어
기록 가능 레이어는 파일을 수정할 수 있습니다. 기록 중 복사 방법을 사용해 읽기 전용 레이어를 수정할 수 있습니다.
수정된 파일은 컨테이너의 기록 가능 레이어에만 남고 다른 레이어에는 존재하지 않습니다. 그래서 다른 이미지 레이어를 복사해서 기록해야만 합니다.
그리고 컨테이너가 삭제되면 기록 가능 레이어에 있는 파일들도 삭제되게 됩니다.
#### critical case
만약 데이터베이스를 docker container로 관리하고 있고 이를 사용해서 파일을 추가하고 수정했는데, 새로운 이미지로 만든 컨테이너에는 이 상태가 반영이 안되어있습니다.

### 도커 볼륨
- 도커 볼륨은 도커에서 스토리지를 다루는 단위입니다.
- 볼륨은 컨테이너와 독립적으로 존재하며, 별도의 생애주기를 갖지만 컨테이너에 연결할 수 있습니다.
- 퍼시스턴시가 필요한 유상태 어플리케이션을 컨테이너로 실행하려면 볼룸을 사용해야합니다. 볼륨을 생성해 어플리케이션 컨테이너에 연결하면 컨테이너 파일 시스템의 한 디렉터리가 됩니다.
나중에 어플리케이션을 업데이트하더라도 새로운 컨테이너에 다시 볼륨을 연결하면 데이터가 그대로 유지된다는 장점이 있습니다.

#### 도커 볼륨을 사용하는 방법은 2가지
1. 수동으로 직접 볼륨을 생성해 컨테이너에 연결하는 방법
2. Dockerfile 스크립트에서 VOLUME 인스트럭션을 사용하는 방법이 있습니다.
   ``` Docker
    FROM diamol/dotnet-aspnet

    WORKDIR /app
    ENTRYPOINT ["dotnet", "ToDoList.dll"]
    
    # set in the base image - `/data` for Linux, `C:\data` for Windows
    VOLUME $SQLITE_DATA_DIRECTORY
    
    # set in the base image - `root` for Linux, `ContainerAdministrator` for Windows
    USER $SQLITE_USER
    
    COPY --from=builder /out/ .
   ```
   - 이렇게 실행한 컨테이너는 도커 볼륨을 생성하게 됩니다.
그러면 새롭게 만든 컨테이너에서 데이터를 마이그레이션하고 싶다면 어떻게 해야할까요?
`docker container run --name {새로운 컨테이너 이름} --volumes-from {기존 컨트레이너 이름} {도커 이미지}`
위 cmd로 기존 컨테이너가 가진 볼륨에 연결을 해서 데이터를 그대로 사용할 수 있게 됩니다.
**주의**
-하지만 이렇게 되면 실수로 여러개의 컨테이너가 파일(볼륨)을 공유하는 상태가 있을 수 있어 오류가 발생할 수 있습니다.
#### 해결법
- 도커 볼륨을 명시적으로 관리하고 별도로 생성해서 관리하는게 올바른 행위입니다.
`docker volume create {도커 볼륨 이름}`
`- v` 옵션을 사용해 도커 볼륨을 연결합니다.
`docker container run -d -v {도커 볼륨 이름}`